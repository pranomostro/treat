#!/usr/bin/env rc

insep=' 	'
outsep='	'

while(~ $1 '-'*)
	switch($1){
	case '-i'
		insep=$2; shift 2
	case '-o'
		outsep=$2; shift 2
	}

tmpdir=`{mktemp -d '/tmp/treat.XXXXXX'}

fifos=`{seq 0 $#*}
ins=$tmpdir^'/'^'in.'^$fifos
outs=$tmpdir^'/'^'out.'^$fifos

mkfifo $ins $outs

paste -d $outsep $outs &

for(i in `{seq 1 $#*})
	eval '<'$ins($i)' '$*($i)' >'$outs($i)' &'

cat <$ins($#ins) >$outs($#outs) &

splitup -s $insep $ins

rm $ins $outs
rmdir $tmpdir
