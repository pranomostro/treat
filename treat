#!/usr/bin/env rc

fn die{
	rm $tmpdir/in.* $tmpdir/out.*
	rmdir $tmpdir
	exit 1
}

fn sigint{ die }; fn sighup{ die }; fn sigalrm{ die }; fn sigfpe{ die }

insep='[	 ]'
outsep='	'

while(~ $1 '-'*)
	switch($1){
	case '-i'
		insep=$2; shift 2
	case '-o'
		outsep=$2; shift 2
	}

tmpdir=`{mktemp -d '/tmp/treat.XXXXXX'}

fifos=`{seq 0 $#*}
ins=$tmpdir^'/'^'in.'^$fifos
outs=$tmpdir^'/'^'out.'^$fifos

mkfifo $ins $outs

for(i in `{seq 1 $#*})
	eval '<'$ins($i)' '$*($i)' >'$outs($i)' &'

paste -d $outsep $outs &

cat <$ins($#ins) >$outs($#outs) &

splitup -s $insep $ins

#process black magic
wait

rm $tmpdir/in.* $tmpdir/out.*
rmdir $tmpdir
